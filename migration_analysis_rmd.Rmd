---
title: "Immigration related debates in UK HOC"
author: "Amir, Ofer, Jan"
date: "12/11/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 1. Introduction

Insert Introduction  

## 2. Packages and data

explian which data has been used and forms the basis of our analysis

```{r library}
#load packages
library(quanteda)
library(quanteda.textmodels)
library(quanteda.sentiment)
library(quanteda.textstats)
library(readtext)
library(tidyverse)
library(stm)
library(lubridate)
library(lme4)
library(lattice)
library(wordcloud)
library(ggridges)
library(plotly)
library(tm)
library(dygraphs)
library(xts)
#load data
Corp_HouseOfCommons_V2  <- readRDS("~/Desktop/tada-hoc/Corp_HouseOfCommons_V2.rds")
```

### 2.1 Subset

explain the subset + limitations
*justifications:* time frame: speeches from 2010 (Justification:Tory manifesto)
                  content: subset to speeches that either contain or termed (agenda) as "immigra*", "refugee*" or "asylum" (according to v.D)
*limitations:* 1. loosing short responses (responses in general); 2. would not include any documents not mentioning "our terms" in either agenda or text


```{r subset}

# select time frame 

HoC_corp_time <- Corp_HouseOfCommons_V2 %>% 
  select(!c(iso3country, party.facts.id, parliament)) %>%
  filter(date>"2009-12-20")


# select relevant content 

HoC_corp_time <- HoC_corp_time[HoC_corp_time$terms>10,]

key_words_img <- c("immigra*","Immigra*","refugee*","Refugee*","asylum","Asylum"," migra*"," Migra*")
HoC_data <- filter(HoC_corp_time, 
                   grepl(paste(key_words_img,collapse="|"), agenda) | 
                     grepl(paste(key_words_img,collapse="|"), text))

```

### 2.2 Foundational Dateframes & Considerations

mention that we will look at two basic subsets: One general one with all oberservations of the initial subset, and one based on the context of the keywords. Justify why. 

mention events etc. 


*2.2.1 General Corpus*
```{r dataframes, echo=FALSE}

HoC_corp <- corpus(HoC_data)

```

*2.2.2 KWIC - Dataframe, Corpus and Dfm*
```{r dataframes_1, echo=FALSE}

# kwic dataframe, corpus and dfm

HoC_kwic <- kwic(HoC_corp, 
                 paste(key_words_img,collapse="|"), 
                 window = 20)

HoC_kwic_data <- tibble(speaker = HoC_kwic$docname, 
                  text = paste(HoC_kwic$pre, 
                               HoC_kwic$post, sep = " ")) 

HoC_kwic_corp <- corpus(HoC_kwic_data)

HoC_kwic_dfm <- dfm(HoC_kwic_corp, 
                remove_punct = TRUE,
                remove = stopwords(),
                remove_symbols = TRUE,
                remove_separators = TRUE,
                split_hyphens = TRUE,
                remove_numbers = TRUE)
```

*2.2.3 General consideration/definitions used across analysis*
```{r dataframes_3, echo=FALSE}

events <- data.frame(Ref = c("2015 General Election", "Brexit Referendum"),
                     vals = c("2015-05-07", "2016-06-23"),
                     stringsAsFactors = FALSE)

```



## 3. Descriptives

Justifications and thoughts here.

- This section looks at the overall prevalence of immigration-realted debates in the HoC between 2010 and 2020, irrespective of party.
- We use a density plot that depicts frequency (y) across time. 
- Any reference is based on the subset and therefore immigration-related.
- Plot 1 shows the number of individual contributions made over time. Technically speaking, this equals the total count of documents for each month between 2010 and 2020. Substantively, one document reflect one individual's contribution irrespective of its length, tone etc.
- Findings plot 1: Need to mention spikes and breaks (likely due to the different phases of the HoC; e.g. summer breaks)

- Plot 2 depicts the amount of unique agenda points either dedicated towards or somehow relating to immigration. Substantively, this means that each agenda point, irrespective of its lengths, will be counted.  
- Findings plot 2: The overall amount of agenda points devoted or somehow related to immigration has almost tripled between 2010 and 2020, with a nearly linear increase over the years. , 

- Plot 3. While plot 1 shows the overall count of unique contributions to immigration-related debates, it does not give substantive insights into the lengths of those contributions. We argue that looking at the overall amount of words used within debates is a relatively clear indicator of the time spent on the respective debate. This is important, as the HoC only has a limited time available, devoting more time towards a debate may indicate certain priorities. In this regard, plot 3 depicts the 6-month-average total amount of words spend on immigration-related debates. By looking at the 6-month averages, we are able to observe whether debate-preferances prevailed over time or whether they only peaked over a short time. To give you an example, looking at the number of words on Dec 2011 indicates the monthly-average amount of words spend on immigration related debates during the second half of 2011. 

- Findings plot 3: While sharp ups and downs were still visible in plots 1 and 2, averaging over 6 months allows for a smoother observation of debate evolution. From January 2012 to November 2014 we are able to observe a steady increase in time spend on debates with regards to their 6-month averages. This is likely due to the spikes showing on a monthly level in both January and June of 2014. The second half of 2014 as well as the first half of 2015 saw less time being devoted to immigration related debates. This suggest that overall, the content on which we selected our subset did not increase in particular prevalence before the 2015 General Election. However, Between May 2015 and June 2016, hence the year following the general election and leading up to the Brexit referendum, saw a major increase in time spend on immigration-related debates. On average, the HoC spend almost twice as much time on immigration related debates during Sep 2015 - Feb 2016 when compared to the period of Dec 2014 - May 2015. Hence, debates seem to have gained in priority after the GEneral election and leading up to the referendum. 


was of lower importance to the General 

*Plot 1:* Prevalence of immigration debates over time by month | Counting documents

```{r plot 1, echo=FALSE}

HoC_data$date <- as.Date(HoC_data$date, format="%Y-%m-%d")

doc_sum_by_month = HoC_data %>% 
  group_by(month=floor_date(date, "month")) %>% 
  summarise(frequency = n()) 

descr_plot_1 <- xts(x = doc_sum_by_month$frequency, order.by = doc_sum_by_month$month)
names(descr_plot_1) <- "# unique contributions"

dygraph(descr_plot_1, 
             main = "Prevalence of immigration debates (by number of unique contributions)", 
             ylab =  "# of words spent on immigration-realted debates", xlab = "Year (by month)") %>% 
  dyOptions(labelsUTC = TRUE, fillGraph=TRUE, fillAlpha=0.4, drawGrid = FALSE, colors="#69b3a2") %>%
  dyRangeSelector() %>%
  dyCrosshair(direction = "vertical") %>%
  dyHighlight(highlightCircleSize = 5, highlightSeriesBackgroundAlpha = 0.2, hideOnMouseOut = FALSE)  %>%
  dyEvent(x="2015-05-07", label = "General Election 2015")%>%
  dyEvent(x="2016-06-23", label = "Brexit Referendum", color = "red")

```

*Plot 2:* Prevalence of immigration debates over time by month | Counting unique agenda points

```{r plot 2, echo=FALSE}
# plot: prevalence of immigration debates over time by month | counting unique agenda points
HoC_data$date <- as.Date(HoC_data$date, format="%Y-%m-%d")

sum_by_agenda = HoC_data %>% 
  group_by(month=floor_date(date, "month"), agenda = agenda) %>% 
  summarise(frequency = n()) 

doc_sum_by_agenda = sum_by_agenda %>% 
  group_by(month=floor_date(month, "month")) %>% 
  summarise(frequency = n()) 

descr_plot_2 <- xts(x = doc_sum_by_agenda$frequency, order.by = doc_sum_by_agenda$month)
names(descr_plot_2) <- "# unique debates"

dygraph(descr_plot_2, 
             main = "Prevalence of immigration debates (by number of unique debates)", 
             ylab =  "# of words spent on immigration-realted debates", xlab = "Year (by month)") %>% 
  dyOptions(labelsUTC = TRUE, fillGraph=TRUE, fillAlpha=0.4, drawGrid = FALSE, colors="#69b3a2") %>%
  dyRangeSelector() %>%
  dyCrosshair(direction = "vertical") %>%
  dyHighlight(highlightCircleSize = 5, highlightSeriesBackgroundAlpha = 0.2, hideOnMouseOut = FALSE)  %>%
  dyEvent(x="2015-05-07", label = "General Election 2015")%>%
  dyEvent(x="2016-06-23", label = "Brexit Referendum", color = "red")
```

*Plot 3:* Prevalence of immigration debates over time by month | Total number of words as a proxy for time spent on debating. 

```{r plot 3, echo=FALSE}
# plot: prevalence of immigration debates over time by month | total number of words as a proxy for time spent on debating. 
HoC_data$date <- as.Date(HoC_data$date, format="%Y-%m-%d")

doc_sum_by_words = HoC_data %>% 
  group_by(month=floor_date(date, "month")) %>% 
  summarise(word_sum = sum(terms)) 

descr_plot_3 <- xts(x = doc_sum_by_words$word_sum, order.by = doc_sum_by_words$month)
names(descr_plot_3) <- "# words"

# Plot
dygraph(descr_plot_3, 
             main = "Prevalence of immigration debates (as 6-month-averages)", 
             ylab =  "# of words spent on immigration-realted debates", xlab = "Year (by month)") %>% 
  dyOptions(labelsUTC = TRUE, fillGraph=TRUE, fillAlpha=0.4, drawGrid = FALSE, colors="#69b3a2") %>%
  dyRangeSelector() %>%
  dyCrosshair(direction = "vertical") %>%
  dyHighlight(highlightCircleSize = 5, highlightSeriesBackgroundAlpha = 0.2, hideOnMouseOut = FALSE)  %>%
  dyRoller(rollPeriod = 6)%>%
  dyEvent(x="2015-05-07", label = "General Election 2015")%>%
  dyEvent(x="2016-06-23", label = "Brexit Referendum", color = "red")
```


## 4. Keywords in Context

Justification and Thoughts here.

*KWIC - Wordcloud incl. keywords*
```{r kwic, echo=FALSE}
textplot_wordcloud(HoC_kwic_dfm, max_words = 90, color = rev(RColorBrewer::brewer.pal(10, "RdBu")))
```

*KWIC - Wordcloud excl. keywords*
```{r kwic_2, echo=FALSE}

## removing also key words to see what is left
HoC_kwic_dfm_no_key <- dfm(HoC_kwic_corp,
                       remove_punct = TRUE,
                       remove = c(as.vector(key_words_img),stopwords()),
                       remove_symbols = TRUE,
                       remove_separators = TRUE,
                       split_hyphens = TRUE,
                       remove_numbers = TRUE)

textplot_wordcloud(HoC_kwic_dfm_no_key, max_words = 90, color = rev(RColorBrewer::brewer.pal(10, "RdBu")))
```

*Frequency of words related to migration (including key terms)*
```{r kwic_3, echo=FALSE}

HoC_dfm_word_freq <- textstat_frequency(HoC_dfm, n=100)
# Sort by reverse frequency order
HoC_dfm_word_freq$feature <- with(HoC_dfm_word_freq, reorder(feature, -frequency))

ggplot(HoC_dfm_word_freq, 
       aes(x = feature, y = frequency)) +
  geom_point() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

```




## 5. Sentiment


*Sentiment | Overall Corpus*
```{r sentiment, echo=FALSE}
sentiment <- textstat_polarity(HoC_corp, 
                               data_dictionary_LSD2015)

sentiment$sent_prob <- 1/(1 + exp(-sentiment$sentiment))

# add sentiment to initial data frame
HoC_data = cbind(HoC_data,sentiment) 

## Graph 1: Sentiment

HoC_data$date <- as.Date(HoC_data$date, format="%Y-%m-%d")
HoC_senti_data <- data.frame(date = HoC_data$date, 
                           sentiment = HoC_data$sentiment)

HoC_senti_data_month = HoC_senti_data %>% 
  group_by(month=floor_date(date, "month")) %>% 
  summarise(avg_sentiment = mean(sentiment))


ggplot(HoC_senti_data_month, aes(x=month, y=avg_sentiment))+
  geom_area( fill="#69b3a2", alpha=0.4, aes(group=1)) +
  geom_line(color="#69b3a2",aes(group=1)) +
  labs(title = "Observed Sentiment in immigration related contributions overall",
       caption = "dashed line (black = 2015 general election, red = Brexit referendum")+
  geom_vline(xintercept = as.numeric(as.Date(events$vals)),
             colour = c("black","red"),
             show.legend = FALSE, linetype ="dashed")+
  theme(axis.text.x = element_text(angle = 90))

## Graph 2: Sentiment by party

HoC_data$date <- as.Date(HoC_data$date, format="%Y-%m-%d")

HoC_senti_data_party <- data.frame(
  date = HoC_data$date, 
  party = HoC_data$party,
  sentiment = HoC_data$sentiment)

HoC_senti_data_party <- HoC_senti_data_party %>% 
  group_by(month=floor_date(date, "month"), party = party) %>% 
  summarise(avg_sentiment = mean(sentiment))

party_senti_plot <- ggplot(HoC_senti_data_party)+
  geom_line(aes(x=month, y=avg_sentiment,group = party), colour = "grey",size = 1) +
  geom_line(data = subset(HoC_senti_data_party, party == "Con") ,aes(x=month, y=avg_sentiment,group = party), colour = "blue",size = 1) +
  geom_line(data = subset(HoC_senti_data_party, party == "Lab") ,aes(x=month, y=avg_sentiment,group = party), colour = "red",size = 1) +
  labs(title = "Observed Sentiment in immigration related contributions overall by party",
       subtitle = "Conservative = blue, Labour = red",
       caption = "dashed line (black = 2015 general election, red = Brexit referendum")+
  geom_vline(xintercept = as.numeric(as.Date(events$vals)),
             colour = c("black","red"),
             show.legend = FALSE, linetype ="dashed")+
  theme(axis.text.x = element_text(angle = 90))

# turn into interactive graph
party_senti_plot <- ggplotly(party_senti_plot)
party_senti_plot



```

*Sentiment | Keywords in Ceontext*
```{r sentiment_2, echo=FALSE}

kwic_sentiment <- textstat_polarity(HoC_kwic_corp, 
                                    data_dictionary_LSD2015)

kwic_sentiment$sent_prob <- 1/(1 + exp(-kwic_sentiment$sentiment))

# add sentiments to initial data frame
HoC_kwic <- cbind(HoC_kwic, kwic_sentiment) 

## KWIC sentiment

length(unique(HoC_data$doc_id)) # for merge, check if doc_id is unique --> yes. 
doc_id_date <- data.frame(date = HoC_data$date,
                          docname = HoC_data$doc_id, 
                          party = HoC_data$party) # add date column to kwic

kwic_date <- merge(HoC_kwic, 
                     doc_id_date, 
                     by = "docname", 
                     all.x = TRUE, 
                     sort = FALSE) # will need to merge based on the docname, as this is the same as the initial doc_id.

kwic_date$date <- as.Date(kwic_date$date, format="%Y-%m-%d")

HoC_kwic_senti_data <- data.frame(
  date = kwic_date$date, 
  sentiment = kwic_date$sentiment)

HoC_kwic_senti_month = HoC_kwic_senti_data %>% 
  group_by(month=floor_date(date, "month")) %>% 
  summarise(avg_sentiment = mean(sentiment))

ggplot(HoC_kwic_senti_month, aes(x=month, y=avg_sentiment)) +
  geom_area( fill="#69b3a2", alpha=0.4, aes(group=1)) +
  geom_line(color="#69b3a2",aes(group=1)) +
  labs(title = "Observed Sentiment in Context of Keywords in immigration related contributions",
       caption = "dashed line (black = 2015 general election, red = Brexit referendum") +
  geom_vline(xintercept = as.Date("2015-05-07"), linetype = "dashed")+ #general election 2015
  geom_vline(xintercept = as.Date("2016-06-23"), linetype = "dashed", color = "red") + # Brexit referendum
  theme(axis.text.x = element_text(angle = 90))

## KWIC sentiment by party

kwic_date$date <- as.Date(kwic_date$date, format="%Y-%m-%d")

HoC_kwic_senti_data_party <- data.frame(
  date = kwic_date$date, 
  party = kwic_date$party,
  sentiment = kwic_date$sentiment)

HoC_kwic_senti_party = HoC_kwic_senti_data_party %>% 
  group_by(month=floor_date(date, "month"), party = party) %>% 
  summarise(avg_sentiment = mean(sentiment))

kwic_senti_party_plot <- ggplot(HoC_kwic_senti_party)+
  geom_line(aes(x=month, y=avg_sentiment,group = party), colour = "grey",size = 1) +
  geom_line(data = subset(HoC_kwic_senti_party, party == "Con") ,aes(x=month, y=avg_sentiment,group = party), colour = "blue",size = 1) +
  geom_line(data = subset(HoC_kwic_senti_party, party == "Lab") ,aes(x=month, y=avg_sentiment,group = party), colour = "red",size = 1) +
  labs(title = "Observed Sentiment in in context of keyword immigration related contributions by party",
       subtitle = "Conservative = blue, Labour = red",
       caption = "dashed line (black = 2015 general election, red = Brexit referendum")+
  geom_vline(xintercept = as.numeric(as.Date(events$vals)),
             colour = c("black","red"),
             show.legend = FALSE, linetype ="dashed")+
  theme(axis.text.x = element_text(angle = 90))

# turn into interactive graph
kwic_senti_party_plot <- ggplotly(kwic_senti_party_plot)
kwic_senti_party_plot

```


## 6. Topics

Text here

*Create Dfm* Include here to also include sentiment in the dfm.
```{r topics_dfm, echo=FALSE}

HoC_dfm <- dfm(HoC_corp, 
                  remove_punct = TRUE,
                  remove = stopwords(),
                  remove_symbols = TRUE,
                  remove_separators = TRUE,
                  split_hyphens = TRUE,
                  remove_numbers = TRUE)

HoC_dfm <- dfm_trim(HoC_dfm,
                  min_termfreq = 2, 
                  min_docfreq = 2)
HoC_dfm <- dfm_subset(HoC_dfm, rowSums(HoC_dfm)>0)

HoC_stm <-asSTMCorpus(HoC_dfm)
```


```{r topics, echo=FALSE}
########################
# Running topic model 1#
########################

# fit a simple model with 6 topics
topic_mod_1 <- stm(HoC_dfm, K = 6, seed = 12345)
topic_labels <- labelTopics(topic_mod_1)

#plot(topic_mod_1, type = "labels", labeltype = "prob") # or frex, lift, score

# wordcloud
cloud(topic_mod_1, topic = 6, max_words = 90, color = c(color = rev(RColorBrewer::brewer.pal(10, "RdBu"))))

# check if topics are exclusive
dotchart(exclusivity(topic_mod_1), labels = 1:6, color = 1:6)

# check if topics are coherent
cohere <- semanticCoherence(topic_mod_1, HoC_dfm)
dotchart(cohere, labels = 1:6, color = 1:6) 

###################################
# Creating topic model data frame #
###################################

# combine stm thetas with dfm docvars
HoC_theta_data <- as.data.frame(topic_mod_1$theta) %>%
  cbind(docvars(HoC_dfm))

## naming topics
#combine first 3 labels as a string for a new label
labels_topic_mod_1 <- c()
for (topicnumber in topic_labels$topicnums){
  first_3<-(str_c(topic_labels$frex[topicnumber,1], 
                  ", " , topic_labels$frex[topicnumber,2], 
                  ", " , topic_labels$frex[topicnumber,3]))
  labels_topic_mod_1<- append(labels_topic_mod_1, first_3)
}

# renaming columns
names(HoC_theta_data)[1:6] <- labels_topic_mod_1
###

####################################
# save/load topic model data frame #
####################################

# save and load topic model dataframe
save(HoC_theta_data, file = "HoC_theta_data.RData")
load("HoC_theta_data.RData")
```


Topic Visualizations:

```{r topic_by_party_plot, echo=FALSE}

## topic_by_party_plot: topic proportions by party 

# grouping by party and generating means 
theta_data_party <- HoC_theta_data %>%
  group_by(party)

theta_data_party_mean <- aggregate(theta_data_party[, 1:6], 
                                   list(theta_data_party$party), 
                                   mean)
names(theta_data_party_mean)[1] <- "Party" 

# Turning into a table of proportions
theta_data_party_prop <- theta_data_party_mean[1] %>%
  cbind(as.data.frame(
    round(100*prop.table(theta_data_party_mean[2:7]),
          digits=2)))

# pivoting df for making figure
party_prop_long <-theta_data_party_prop %>%
  pivot_longer(c(2:7), 
               names_to = "Topic", 
               values_to = "Proportion")

# visualizing proportions of topics by party
topic_by_party_plot <- party_prop_long %>%
  ggplot(aes(Party, Proportion, fill = Topic)) +
  geom_bar(position = "fill", stat = "identity") +
  scale_y_continuous() + 
  theme(axis.text.x = element_text(angle = 45, 
                                   hjust = 1, 
                                   size = 6))
topic_by_party_plot
```


```{r topics_by_time_plot, echo=FALSE}

## topic_by_party_plot: topic proportions by party 

theta_data_long <- pivot_longer(
  HoC_theta_data, 
  cols = names(HoC_theta_data[1:6]), 
  names_to = "topic",
  values_to = "theta")

# plot topic theta means over years
theta_long_data_year <- theta_data_long %>%
  mutate(year = str_sub(date, 1, 4)) %>%
  group_by(year, topic) %>% 
  summarise(theta.means = mean(theta))

topics_by_time_plot <- ggplot(theta_long_data_year,aes(x=year, y=theta.means, group = 1, color = topic)) + 
  geom_point() +
  geom_line() +
  geom_vline(xintercept = "2015", linetype = "dashed")+ #general election 2015
  geom_vline(xintercept = "2016", linetype = "dashed", color = "red")+ # Brexit referendum
  facet_wrap(~topic)

topics_by_time_plot
```

```{r ind_topics_by_time_by_party_plot, echo=FALSE}

####### showing development of 1 topic over time across parties
# plot topic theta means by party over years
theta_long_data_year_1 <- theta_data_long %>%
  mutate(year = str_sub(date, 1, 4)) %>%
  group_by(year, topic, party) %>% 
  summarise(theta.means = mean(theta)) %>%
  filter(party == "Con" | party == "Lab" | party == "GPEW" | party == "Independent" | party == "LibDem" | party == "PlaidCymru" | party == "SDLP" | party == "SNP")

# plot all parties together (plot by party, color by topic)
ggplot()  +
  geom_line(data = theta_long_data_year_1, aes(x=year, y = theta.means, group = topic, colour = topic)) + 
  geom_vline(xintercept = "2015", linetype = "dashed")+ #general election 2015
  geom_vline(xintercept = "2016", linetype = "dashed", color = "red")+ # Brexit referendum
  facet_wrap(~party)

# plot all parties together (plot by topic, color by party)
k <- ggplot()  +
  geom_line(data = theta_long_data_year_1, aes(x=year, y = theta.means, group = party, colour = party)) + 
  geom_line(data = theta_long_data_year,aes(x=year, y=theta.means, group = 1)) +
  geom_vline(xintercept = "2015", linetype = "dashed")+ #general election 2015
  geom_vline(xintercept = "2016", linetype = "dashed", color = "red")+ # Brexit referendum
  facet_wrap(~topic)
k

# make interactive
k <- ggplotly(k)
k
# Jan: still needs vlines for election and brexit 
```

```{r topics_4, echo=FALSE}

# graph sentiment by topics
sentiment_data_long <- theta_data_long %>%
  mutate(year = str_sub(date, 1, 4)) %>%
  group_by(year, topic, party) %>% 
  summarise(sentiment.means = mean(sentiment))

sentiment_long_party <- cbind(sentiment_data_long, theta.means = theta_long_data_year_1$theta.means)

sentiment_long_party$year <- as.Date(sentiment_long_party$year, format = "%Y")

ggplot(sentiment_long_party)+
  geom_line(aes(x = year, y=sentiment.means, group=party), colour = "grey") +
  geom_line(data = subset(sentiment_long_party, party == "Con"), aes(x = year, y=sentiment.means, group=party), colour = "blue") +
  geom_line(data = subset(sentiment_long_party, party == "Lab"), aes(x = year, y=sentiment.means, group=party), colour = "red") +
  labs(title = "Observed Sentiment by partyand topic",
       caption = "dashed line (black = 2015 general election, red = Brexit referendum")+
  geom_vline(xintercept = as.Date("2015-05-07"), linetype = "dashed")+ #general election 2015
  geom_vline(xintercept = as.Date("2016-06-23"), linetype = "dashed", color = "red")+ # Brexit referendum
  facet_wrap(~topic)


# Topic prevalence and observed Sentiment by party for Conservatives and Labour. 
ggplot(subset(sentiment_long_party, party == c("Con","Lab")))+
  geom_line(aes(x = year, y=theta.means, color = topic)) +
  geom_line(data = subset(sentiment_long_party, party == c("Con","Lab")), aes(x = year, y=sentiment.means), linetype="dashed", colour = "darkgrey") +
  labs(title = "Topic prevalence and observed Sentiment by party",
       caption = "dashed line (black = 2015 general election, red = Brexit referendum")+
  geom_vline(xintercept = as.Date("2015-05-07"), linetype = "dashed")+ #general election 2015
  geom_vline(xintercept = as.Date("2016-06-23"), linetype = "dashed", color = "red")+ # Brexit referendum
  facet_wrap(~party)



# Topic prevalence and observed Sentiment by party for Conservatives and Labour. 
ggplot(subset(sentiment_long_party, party == c("Con","Lab", "GPEW", "Independent", "LibDem", "PlaidCymru", "SDLP", "SNP")))+
  geom_line(aes(x = year, y=theta.means, color = topic)) +
  geom_line(data = subset(sentiment_long_party, party == c("Con","Lab", "GPEW", "Independent", "LibDem", "PlaidCymru", "SDLP", "SNP")), aes(x = year, y=sentiment.means), linetype="dashed", colour = "darkgrey") +
  labs(title = "Topic prevalence and observed Sentiment by party",
       caption = "dashed line (black = 2015 general election, red = Brexit referendum")+
  geom_vline(xintercept = as.Date("2015-05-07"), linetype = "dashed")+ #general election 2015
  geom_vline(xintercept = as.Date("2016-06-23"), linetype = "dashed", color = "red")+ # Brexit referendum
  facet_wrap(~party)


```

```{r topics-sentiment regression, echo=FALSE}
head(sentiment_long_party)

#subset data to just one topic (1)
sentiment_long_party_topic1 <- sentiment_long_party %>%
  filter(topic == names(HoC_theta_data)[1])

#subset data to just one topic (2)
sentiment_long_party_topic2 <- sentiment_long_party %>%
  filter(topic == names(HoC_theta_data)[2])

#subset data to just one topic (3)
sentiment_long_party_topic3 <- sentiment_long_party %>%
  filter(topic == names(HoC_theta_data)[3])

#subset data to just one topic (4)
sentiment_long_party_topic4 <- sentiment_long_party %>%
  filter(topic == names(HoC_theta_data)[4])

#subset data to just one topic (5)
sentiment_long_party_topic5 <- sentiment_long_party %>%
  filter(topic == names(HoC_theta_data)[5])

#subset data to just one topic (6)
sentiment_long_party_topic6 <- sentiment_long_party %>%
  filter(topic == names(HoC_theta_data)[6])

# regression models for each topic (effect of topic on sentiment, controlling for party and year)
names(HoC_theta_data)[1]
reg1 <- lm(sentiment.means~theta.means+party+year, data=sentiment_long_party_topic1)
summary(reg1)

names(HoC_theta_data)[2]
reg2 <- lm(sentiment.means~theta.means+party+year, data=sentiment_long_party_topic2)
summary(reg2)

names(HoC_theta_data)[3]
reg3 <- lm(sentiment.means~theta.means+party+year, data=sentiment_long_party_topic3)
summary(reg3)

names(HoC_theta_data)[4]
reg4 <- lm(sentiment.means~theta.means+party+year, data=sentiment_long_party_topic4)
summary(reg4)

names(HoC_theta_data)[5]
reg5 <- lm(sentiment.means~theta.means+party+year, data=sentiment_long_party_topic5)
summary(reg5)

names(HoC_theta_data)[6]
reg6 <- lm(sentiment.means~theta.means+party+year, data=sentiment_long_party_topic6)
summary(reg6)

# think on how best to plot these...
```


```{r topics_5, echo=FALSE}
# fit a simple model with 12 topics
topic_mod_2 <- stm(HoC_dfm, K = 12, seed = 12345)
labelTopics(topic_mod_2)
#plot(topic_mod_2, type = "labels", labeltype = "prob") # or frex, lift, score

# check if topics are exclusive 
dotchart(exclusivity(topic_mod_2), labels = 1:12)

#check if topics are coherent
cohere <- semanticCoherence(topic_mod_2, HoC_dfm)
dotchart(cohere, labels = 1:12)
```


```{r topics_6, echo=FALSE}
# topic model prevelance by party
# new topic model mod3  --> @Amir check why error showss up regarding content covariate lenght? 

topic_mod_3 <- stm(HoC_stm$documents, vocab = HoC_stm$vocab, 
             K = 6, ~ party, data=HoC_stm$data, seed = 12345)
#estimating the effect in term of topic-proportions which are the outcome variable. 
#conditional expectation of topic prevalence given document characteristics.
topic_mod_3 <- estimateEffect(1:6~HoC_stm$party, topic_mod_1, HoC_stm)

#plot to see exclusivity of topics
plot(topicCorr(topic_mod_3))
#plot to chec
topicQuality(topic_mod_3, documents = HoC_stm$documents)
dim(topic_mod_3$beta$logbeta[[1]])

#code to add labels
labels <- apply(sageLabels(topic_mod_1)$marginal$frex, 1,
                function(x){ paste(x[1:4], collapse = "-") })


```

## 7. Exploratory part (just for ourselves)
Text here


```{r just for us, echo=FALSE}

# some examples of agendas
head(unique(Corp_HouseOfCommons_V2$agenda))
#number of agendas
length(unique(Corp_HouseOfCommons_V2$agenda))
length(Corp_HouseOfCommons_V2$agenda)
Corp_HouseOfCommons_V2$agenda["migration"]

## just to check what the sentiment analysis does: 

text <- data.frame(text =c("nice","evil","and"))
text <- corpus(text)
sent_text <- textstat_polarity(text, 
                               data_dictionary_LSD2015)


#### Sentiment only for refugee* by party
refu <- c("refugee*","Refugee*")
refugee <- filter(HoC_corp_time, grepl(paste(refu,collapse="|"), agenda) | grepl(paste(refu,collapse="|"), text))
refcorp <- corpus(refugee)

ref_sent <- textstat_polarity(refcorp, 
                              data_dictionary_LSD2015)
ref_sent$sent_prob <- 1/(1 + exp(-ref_sent$sentiment))

refugee = cbind(refugee,ref_sent)

refugee$date <- as.Date(refugee$date, format="%Y-%m-%d")
ref_party_df <- data.frame(date = refugee$date, party = refugee$party ,sentiment = refugee$sentiment)
ref_party = ref_party_df %>% group_by(month=floor_date(date, "month"), party = party) %>% summarise(avg_sentiment = mean(sentiment))

ggplot(ref_party)+
  geom_line(aes(x=month, y=avg_sentiment,group = party), colour = "grey",size = 1) +
  geom_line(data = subset(ref_party, party == "Con") ,aes(x=month, y=avg_sentiment,group = party), colour = "red",size = 1) +
  geom_line(data = subset(ref_party, party == "Lab") ,aes(x=month, y=avg_sentiment,group = party), colour = "blue",size = 1) +
  labs(title = "Observed Sentiment in refugee*- related contributions overall by party",
       subtitle = "Conservative = red, Labour = blue",
       caption = "dashed line (black = 2015 general election, red = Brexit referendum")+
  geom_vline(xintercept = as.Date("2015-05-07"), linetype = "dashed")+ #general election 2015
  geom_vline(xintercept = as.Date("2016-06-23"), linetype = "dashed", color = "red")+ # Brexit referendum
  theme(axis.text.x = element_text(angle = 90))


```



Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
