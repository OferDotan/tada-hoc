---
title: "Immigration related debates in UK HOC"
author: "Amir, Ofer, Jan"
date: "12/11/2020"
output:
  prettydoc::html_pretty:
    theme: hpstr
    highlight: github
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r load packages, results = 'hide', message = FALSE, warning=FALSE, echo=FALSE, fig.show='hide'}
library(quanteda)
library(quanteda.textmodels)
library(quanteda.sentiment)
library(quanteda.textstats)
library(readtext)
library(tidyverse)
library(stm)
library(lubridate)
library(lme4)
library(lattice)
library(wordcloud)
library(ggridges)
library(plotly)
library(tm)
library(dygraphs)
library(xts)
library(ggiraphExtra)
library(car)

```

```{r load data, results = 'hide', message = FALSE, warning=FALSE, echo=FALSE, fig.show='hide'}

Corp_HouseOfCommons_V2  <- readRDS("~/Desktop/tada-hoc/Corp_HouseOfCommons_V2.rds")
```


### 2.1 Subset


```{r subset, results = 'hide', message = FALSE, warning=FALSE, echo=FALSE, fig.show='hide'}

# select time frame 

HoC_corp_time_0 <- Corp_HouseOfCommons_V2 %>% 
  select(!c(iso3country, party.facts.id, parliament)) %>%
  filter(date>"2009-12-31") #749177 obs.


# select relevant content 

HoC_corp_time <- HoC_corp_time_0[HoC_corp_time_0$terms>10,] #708998 obs.

key_words_img <- c("immigra*","Immigra*","refugee*","Refugee*","asylum","Asylum"," migra*"," Migra*")
HoC_data <- filter(HoC_corp_time, 
                   grepl(paste(key_words_img,collapse="|"), agenda) | 
                     grepl(paste(key_words_img,collapse="|"), text)) #22909 obs.

# select the 5 parties with highest contribution, covering >98% of the initial content

party_contr <- HoC_data %>%
  group_by(party) %>% 
  summarise(contribution=(sum(terms)/sum(HoC_data$terms))*100)

party_contr <- party_contr[order(party_contr$contribution, decreasing = TRUE),]

parties <- party_contr$party[1:5]

HoC_data <- filter(HoC_data, grepl(paste(parties,collapse="|"), party))#22257 obs.


```

### 2.2 Foundational Dateframes & Considerations

mention that we will look at two basic subsets: One general one with all obrservations of the initial subset, and one based on the context of the keywords. Justify why. 

mention events etc. 


*2.2.1 General Corpus*
```{r dataframes, results = 'hide', message = FALSE, warning=FALSE, echo=FALSE, fig.show='hide'}

HoC_corp <- corpus(HoC_data)

```


*2.2.3 General consideration/definitions used across analysis*
```{r dataframes_3, results = 'hide', message = FALSE, warning=FALSE, echo=FALSE, fig.show='hide'}

events <- data.frame(Ref = c("2015 General Election", "Brexit Referendum"),
                     vals = c("2015-05-07", "2016-06-23"),
                     stringsAsFactors = FALSE)

```


## 3. Descriptives

Justifications and throughts here.

```{r subset of all debate, results = 'hide', message = FALSE, warning=FALSE, echo=FALSE, fig.show='hide'}

# subset as % of overall debates within same time frame 2.97%

nrow(HoC_data)/nrow(HoC_corp_time_0)*100

# subset as % of time spend 6.244%

sum(HoC_data$terms)/sum(HoC_corp_time_0$terms)*100


# time spend on immigration related debates during the year before Election compared to the year before Brexit


contr_elect <- sum(HoC_data$terms[HoC_data$date <= "2015-05-07" & HoC_data$date >= "2014-05-07"])

contr_brex <- sum(HoC_data$terms[HoC_data$date <= "2016-06-23" & HoC_data$date >= "2015-06-23"])

contr_brex/contr_elect # 75.2% more time spend on immigration related debates in year leading up to Brexit compared to the one leading up to election.

```
```{r plot 1, results = 'hide', message = FALSE, warning=FALSE, echo=FALSE, fig.show='hide'}
# *Plot 1:* Prevalence of immigration debates over time by month | Counting documents
HoC_data$date <- as.Date(HoC_data$date, format="%Y-%m-%d")

doc_sum_by_month = HoC_data %>% 
  group_by(month=floor_date(date, "month")) %>% 
  summarise(frequency = n()) 

descr_plot_1 <- xts(x = doc_sum_by_month$frequency, order.by = doc_sum_by_month$month)
names(descr_plot_1) <- "# unique contributions"

dygraph(descr_plot_1, 
             main = "Prevalence of immigration debates (by number of unique contributions)", 
             ylab =  "# of words spent on immigration-realted debates", xlab = "Year (by month)") %>% 
  dyOptions(labelsUTC = TRUE, fillGraph=TRUE, fillAlpha=0.4, drawGrid = FALSE, colors="#69b3a2") %>%
  dyRangeSelector() %>%
  dyCrosshair(direction = "vertical") %>%
  dyHighlight(highlightCircleSize = 5, highlightSeriesBackgroundAlpha = 0.2, hideOnMouseOut = FALSE)  %>%
  dyEvent(x="2015-05-07", label = "General Election 2015")%>%
  dyEvent(x="2016-06-23", label = "Brexit Referendum", color = "red")

```
```{r plot 2, results = 'hide', message = FALSE, warning=FALSE, echo=FALSE, fig.show='hide'}
#*Plot 2:* Prevalence of immigration debates over time by month | Counting unique agenda points
HoC_data$date <- as.Date(HoC_data$date, format="%Y-%m-%d")

sum_by_agenda = HoC_data %>% 
  group_by(month=floor_date(date, "month"), agenda = agenda) %>% 
  summarise(frequency = n()) 

doc_sum_by_agenda = sum_by_agenda %>% 
  group_by(month=floor_date(month, "month")) %>% 
  summarise(frequency = n()) 

descr_plot_2 <- xts(x = doc_sum_by_agenda$frequency, order.by = doc_sum_by_agenda$month)
names(descr_plot_2) <- "# unique debates"

dygraph(descr_plot_2, 
             main = "Prevalence of immigration debates (by number of unique debates)", 
             ylab =  "# of words spent on immigration-realted debates", xlab = "Year (by month)") %>% 
  dyOptions(labelsUTC = TRUE, fillGraph=TRUE, fillAlpha=0.4, drawGrid = FALSE, colors="#69b3a2") %>%
  dyRangeSelector() %>%
  dyCrosshair(direction = "vertical") %>%
  dyHighlight(highlightCircleSize = 5, highlightSeriesBackgroundAlpha = 0.2, hideOnMouseOut = FALSE)  %>%
  dyEvent(x="2015-05-07", label = "General Election 2015")%>%
  dyEvent(x="2016-06-23", label = "Brexit Referendum", color = "red")
```

*Plot 3:* Prevalence of immigration debates over time by month | Total number of words as a proxy for time spent on debating. 

```{r plot 3, echo=FALSE,  message = FALSE}
# plot: prevalence of immigration debates over time by month | total number of words as a proxy for time spent on debating. 
HoC_data$date <- as.Date(HoC_data$date, format="%Y-%m-%d")

doc_sum_by_words = HoC_data %>% 
  group_by(month=floor_date(date, "month")) %>% 
  summarise(word_sum = sum(terms)) 

descr_plot_3 <- xts(x = doc_sum_by_words$word_sum, order.by = doc_sum_by_words$month)
names(descr_plot_3) <- "# words"

# Plot
dygraph(descr_plot_3, 
             main = "Prevalence of immigration debates (as 6-month-averages)", 
             ylab =  "# of words spent on immigration-realted debates", xlab = "Year (by month)") %>% 
  dyOptions(labelsUTC = TRUE, fillGraph=TRUE, fillAlpha=0.4, drawGrid = FALSE, colors="#69b3a2") %>%
  dyRangeSelector() %>%
  dyCrosshair(direction = "vertical") %>%
  dyHighlight(highlightCircleSize = 5, highlightSeriesBackgroundAlpha = 0.2, hideOnMouseOut = FALSE)  %>%
  dyRoller(rollPeriod = 6)%>%
  dyEvent(x="2015-05-07", label = "General Election 2015")%>%
  dyEvent(x="2016-06-23", label = "Brexit Referendum", color = "red")
```
*Concentration of party-specific contributions*

```{r plot 4: prevalence by party, results = 'hide', message = FALSE, warning=FALSE, echo=FALSE }

# library
HoC_data$date <- as.Date(HoC_data$date, format="%Y-%m-%d")

sum_by_party = HoC_data %>% 
  group_by(month=floor_date(date, "day"), party = party) %>% 
  summarise(frequency = sum(terms)) 

# Plot
ggplot(sum_by_party, aes(x = month, y = party, fill = party)) +
  geom_density_ridges(alpha=0.6) +
  labs(title = "Number of words spent on immigration-realted debates",
       subtitle = "by party")+
  geom_vline(xintercept = as.Date("2015-05-07"), linetype = "dashed")+ #general election 2015
  geom_vline(xintercept = as.Date("2016-06-23"), linetype = "dashed", color = "red") # Brexit referendum

```

This density plot gives us a sense of the frequency each party discussed each party discussed each month during the time frame of our research. Basically what it does it counts how many words each party each party invested in speaking about immigration related topics. So for example, while the SNP and the DUP spoke more about immigration after Brexit, other parties exhibit a more constant trend of engagement with immigration related speech. Importantly, the information that can be gathered from this graph is limited in that it does not tell us anything about substance of these speeches, but crudely how many words were used. Nevertheless, this descriptive visualization does help us get an initial sense about the prevelance of immigration related speech in each of the parties we are focusing on.      

## 4. Sentiment


*Sentiment | Overall Corpus*
```{r sentiment, results = 'hide', message = FALSE, warning=FALSE, echo=FALSE, fig.show='hide'}
sentiment <- textstat_polarity(HoC_corp, 
                               data_dictionary_LSD2015)

sentiment$sent_prob <- 1/(1 + exp(-sentiment$sentiment))

# add sentiment to initial data frame
HoC_data = cbind(HoC_data,sentiment) 
```

*Graph 1: Overall Sentiment*
```{r sentiment graph 1, results = 'hide', message = FALSE, warning=FALSE, echo=FALSE, fig.show='hide'}

HoC_data$date <- as.Date(HoC_data$date, format="%Y-%m-%d")
HoC_senti_data <- data.frame(date = HoC_data$date, 
                           sentiment = HoC_data$sentiment)

HoC_senti_data_month = HoC_senti_data %>% 
  group_by(month=floor_date(date, "month")) %>% 
  summarise(avg_sentiment = mean(sentiment))


ggplot(HoC_senti_data_month, aes(x=month, y=avg_sentiment))+
  geom_area( fill="#69b3a2", alpha=0.4, aes(group=1)) +
  geom_line(color="#69b3a2",aes(group=1)) +
  labs(title = "Observed Sentiment in immigration related contributions overall",
       caption = "dashed line (black = 2015 general election, red = Brexit referendum")+
  geom_vline(xintercept = as.numeric(as.Date(events$vals)),
             colour = c("black","red"),
             show.legend = FALSE, linetype ="dashed")+
  theme(axis.text.x = element_text(angle = 90))
```

*Graph 2: Sentiment by party*
```{r sentiment graph 2, echo=FALSE,  message = FALSE}

HoC_data$date <- as.Date(HoC_data$date, format="%Y-%m-%d")

HoC_senti_data_party <- data.frame(
  date = HoC_data$date, 
  party = HoC_data$party,
  sentiment = HoC_data$sentiment)

HoC_senti_data_party <- HoC_senti_data_party %>% 
  group_by(month=floor_date(date, "month"), party = party) %>% 
  summarise(avg_sentiment = mean(sentiment))

party_senti_plot <- ggplot(HoC_senti_data_party)+
  geom_line(aes(x=month, y=avg_sentiment,group = party), colour = "grey",size = 1) +
  geom_line(data = subset(HoC_senti_data_party, party == "Con") ,aes(x=month, y=avg_sentiment,group = party), colour = "blue",size = 1) +
  geom_line(data = subset(HoC_senti_data_party, party == "Lab") ,aes(x=month, y=avg_sentiment,group = party), colour = "red",size = 1) +
  labs(title = "Observed Sentiment in immigration related contributions overall by party",
       subtitle = "Conservative = blue, Labour = red",
       caption = "dashed line (black = 2015 general election, red = Brexit referendum")+
  geom_vline(xintercept = as.numeric(as.Date(events$vals)),
             colour = c("black","red"),
             show.legend = FALSE, linetype ="dashed")+
  theme(axis.text.x = element_text(angle = 90))

# turn into interactive graph
party_senti_plot <- ggplotly(party_senti_plot)
party_senti_plot

```



## 5. Sentiment in Context

*2.2.2 Create KWIC - Dataframe, Corpus and Dfm*
```{r dataframes_1, results = 'hide', message = FALSE, warning=FALSE, echo=FALSE, fig.show='hide'}
#rerun general corpus to include sentiment
HoC_corp <- corpus(HoC_data)

#remove weird strings - only relevant for kwic as we want to analyze sentiment by keywords.

HoC_corp <- gsub("[[:punct:]]â"," ", HoC_corp) # manually retrieved by investigating unique keyword-strings 
HoC_corp <- gsub("([œ])","", HoC_corp)
HoC_corp <- gsub("([â])","", HoC_corp)

HoC_kwic <- kwic(HoC_corp, 
                 paste(key_words_img,collapse="|"), 
                 window = 20,
                 split_hyphens = TRUE)

HoC_kwic_data <- tibble(speaker = HoC_kwic$docname, 
                  text = paste(HoC_kwic$pre, 
                               HoC_kwic$post, sep = " "),
                  keyword = HoC_kwic$keyword,
                  docname = HoC_kwic$docname) 
```


*Subset KWIC according to keywords*
```{r sentiment kwic, results = 'hide', message = FALSE, warning=FALSE, echo=FALSE, fig.show='hide'}

imm <- c("immigra*","Immigra*")
refu <- c("refugee*","Refugee*")
asyl <- c("asylum","Asylum")

kwic_imm <- filter(HoC_kwic_data,
                   grepl(paste(imm,collapse="|"), keyword))
kwic_refu <- filter(HoC_kwic_data,
                   grepl(paste(refu,collapse="|"), keyword))
kwic_asyl <- filter(HoC_kwic_data,
                   grepl(paste(asyl,collapse="|"), keyword))

```

```{r sentiment kwic 2, results = 'hide', message = FALSE, warning=FALSE, echo=FALSE, fig.show='hide'}
# make individual corpora
kwic_imm_corp <- corpus(kwic_imm)
kwic_refu_corp <- corpus(kwic_refu)
kwic_asyl_corp <- corpus(kwic_asyl)

```



*Sentiment  Keywords in Context of keyword*
```{r sentiment kwic 3,results = 'hide', message = FALSE, warning=FALSE, echo=FALSE, fig.show='hide'}

kwic_imm_senti <- textstat_polarity(kwic_imm_corp, 
                                    data_dictionary_LSD2015)
kwic_refu_senti <- textstat_polarity(kwic_refu_corp, 
                                    data_dictionary_LSD2015)
kwic_asyl_senti <- textstat_polarity(kwic_asyl_corp, 
                                    data_dictionary_LSD2015)


# add sentiments to initial data frame

kwic_imm <- cbind(kwic_imm, kwic_imm_senti) 
kwic_refu <- cbind(kwic_refu, kwic_refu_senti)
kwic_asyl <- cbind(kwic_asyl, kwic_asyl_senti)

## add date and party 

doc_id_date <- data.frame(date = HoC_data$date,
                          docname = HoC_data$doc_id, 
                          party = HoC_data$party) # add date column to kwic

kwic_imm_fv <- merge(kwic_imm, 
                     doc_id_date, 
                     by = "docname", 
                     all.x = TRUE, 
                     sort = FALSE)
kwic_refu_fv <- merge(kwic_refu, 
                     doc_id_date, 
                     by = "docname", 
                     all.x = TRUE, 
                     sort = FALSE)
kwic_asyl_fv <- merge(kwic_asyl, 
                     doc_id_date, 
                     by = "docname", 
                     all.x = TRUE, 
                     sort = FALSE)

```

*Graph 3: KWIC sentiment*
#### I think this should also be discarded. It is kind of strange maybe to plot sentiment based on bubbles of 40 words at a time, or, we could justify it by assuming that in these bubbles speeches are likely to be really related to immigration which is also where most sentiment is likely to be voiced. But I am not that convinced by this myself.  

```{r kwic sentiment by party immigra, results = 'hide', message = FALSE, warning=FALSE, echo=FALSE}

kwic_imm_fv$date <- as.Date(kwic_imm_fv$date, format="%Y-%m-%d")

kwic_imm_party <- kwic_imm_fv %>% 
  group_by(month=floor_date(date, "month"), party = party) %>% 
  summarise(avg_sentiment = mean(sentiment))

ggplot(kwic_imm_party)+
  geom_line(aes(x=month, y=avg_sentiment,group = party), colour = "grey",size = 1) +
  geom_line(data = subset(HoC_senti_data_party, party == "Con") ,aes(x=month, y=avg_sentiment,group = party), colour = "blue",size = 1) +
  geom_line(data = subset(HoC_senti_data_party, party == "Lab") ,aes(x=month, y=avg_sentiment,group = party), colour = "red",size = 1) +
  labs(title = "Observed Sentiment in context of immigra* by party",
       subtitle = "Conservative = blue, Labour = red",
       caption = "dashed line (black = 2015 general election, red = Brexit referendum")+
  geom_vline(xintercept = as.numeric(as.Date(events$vals)),
             colour = c("black","red"),
             show.legend = FALSE, linetype ="dashed")+
  theme(axis.text.x = element_text(angle = 90))

```

```{r kwic sentiment by party refuge, results = 'hide', message = FALSE, warning=FALSE, echo=FALSE}

kwic_refu_fv$date <- as.Date(kwic_refu_fv$date, format="%Y-%m-%d")

kwic_refu_party <- kwic_refu_fv %>% 
  group_by(month=floor_date(date, "month"), party = party) %>% 
  summarise(avg_sentiment = mean(sentiment))

ggplot(kwic_refu_party)+
  geom_line(aes(x=month, y=avg_sentiment,group = party), colour = "grey",size = 1) +
  geom_line(data = subset(HoC_senti_data_party, party == "Con") ,aes(x=month, y=avg_sentiment,group = party), colour = "blue",size = 1) +
  geom_line(data = subset(HoC_senti_data_party, party == "Lab") ,aes(x=month, y=avg_sentiment,group = party), colour = "red",size = 1) +
  labs(title = "Observed Sentiment in context of refuge* by party",
       subtitle = "Conservative = blue, Labour = red",
       caption = "dashed line (black = 2015 general election, red = Brexit referendum")+
  geom_vline(xintercept = as.numeric(as.Date(events$vals)),
             colour = c("black","red"),
             show.legend = FALSE, linetype ="dashed")+
  theme(axis.text.x = element_text(angle = 90))

```

```{r kwic sentiment by party asylum, results = 'hide', message = FALSE, warning=FALSE, echo=FALSE}

kwic_asyl_fv$date <- as.Date(kwic_asyl_fv$date, format="%Y-%m-%d")

kwic_asyl_party <- kwic_asyl_fv %>% 
  group_by(month=floor_date(date, "year"), party = party) %>% 
  summarise(avg_sentiment = mean(sentiment))

ggplot(kwic_asyl_party)+
  geom_line(aes(x=month, y=avg_sentiment,group = party), colour = "grey",size = 1) +
  geom_line(data = subset(HoC_senti_data_party, party == "Con") ,aes(x=month, y=avg_sentiment,group = party), colour = "blue",size = 1) +
  geom_line(data = subset(HoC_senti_data_party, party == "Lab") ,aes(x=month, y=avg_sentiment,group = party), colour = "red",size = 1) +
  labs(title = "Observed Sentiment in context of asylum by party",
       subtitle = "Conservative = blue, Labour = red",
       caption = "dashed line (black = 2015 general election, red = Brexit referendum")+
  geom_vline(xintercept = as.numeric(as.Date(events$vals)),
             colour = c("black","red"),
             show.legend = FALSE, linetype ="dashed")+
  theme(axis.text.x = element_text(angle = 90))

```

```{r sentiment kwic graph 3, results = 'hide', message = FALSE, warning=FALSE, echo=FALSE}

kwic_senti <- data.frame(kwic_imm_fv %>% 
  group_by(month=floor_date(date, "year")) %>% 
  summarise(avg_sentiment = mean(sentiment)),
kwic_refu_party <- kwic_refu_fv %>% 
  group_by(month=floor_date(date, "year")) %>% 
  summarise(avg_sentiment = mean(sentiment)),
kwic_refu_party <- kwic_asyl_fv %>% 
  group_by(month=floor_date(date, "year")) %>% 
  summarise(avg_sentiment = mean(sentiment)))

kwic_senti <- data.frame(date = kwic_senti$month, immigra = kwic_senti$avg_sentiment, refuge = kwic_senti$avg_sentiment.1 ,asylum = kwic_senti$avg_sentiment.2)

kwic_senti$date <- as.Date(kwic_senti$date, format="%Y-%m-%d")

ggplot(kwic_senti, aes(x=date)) +
  geom_line(color="red",aes(y=immigra)) +
  geom_line(color="green",aes(y=refuge)) +
  geom_line(color="black",aes(y=asylum)) +
  labs(title = "Observed Sentiment in Context of Keywords",
       subtitle = "red = immigra*, green = refuge*, black = asylum",
       caption = "dashed line (black = 2015 general election, red = Brexit referendum") +
  geom_vline(xintercept = as.Date("2015-05-07"), linetype = "dashed")+ #general election 2015
  geom_vline(xintercept = as.Date("2016-06-23"), linetype = "dashed", color = "red") + # Brexit referendum
  theme(axis.text.x = element_text(angle = 90))

```

